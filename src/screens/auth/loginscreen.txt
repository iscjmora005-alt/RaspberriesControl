import React, { useState } from "react";
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  Image,
  Alert,
  KeyboardAvoidingView,
  Platform,
} from "react-native";
import { StackNavigationProp } from "@react-navigation/stack";
// Importamos los tipos que definimos
import { RootStackParamList } from "../../navigation/StackNavigator";
import { LoginFormData, COLORS, FONT_SIZES } from "../../../types/index";
// Importamos la imagen
const loginImage = require("../../../assets/iconlogin.jpg");
/**
 * Tipo para las props de navegaci贸n de esta pantalla
 */
type LoginScreenNavigationProp = StackNavigationProp<
  RootStackParamList,
  "Login"
>;
/**
 * Props que recibe el componente LoginScreen
 */
interface LoginScreenProps {
  navigation: LoginScreenNavigationProp;
}
/**
 * Pantalla de inicio de sesi贸n
 * Permite a los usuarios autenticarse en el sistema
 */
const LoginScreen: React.FC<LoginScreenProps> = ({ navigation }) => {
  // Estados del formulario usando el tipo LoginFormData
  const [formData, setFormData] = useState<LoginFormData>({
    username: "",
    password: "",
  });
  // Estado para controlar si est谩 cargando
  const [isLoading, setIsLoading] = useState<boolean>(false);
  /**
   * Actualiza los datos del formulario
   * @param field - Campo a actualizar ('username' o 'password')
   * @param value - Nuevo valor del campo
   */
  const updateFormData = (field: keyof LoginFormData, value: string): void => {
    setFormData((prevData) => ({
      ...prevData,
      [field]: value,
    }));
  };
  /**
   * Valida que los campos del formulario no est茅n vac铆os
   * @returns true si los campos son v谩lidos, false en caso contrario
   */
  const validateForm = (): boolean => {
    if (!formData.username.trim()) {
      Alert.alert("Error", "Por favor, ingrese su usuario");
      return false;
    }
    if (!formData.password.trim()) {
      Alert.alert("Error", "Por favor, ingrese su contrase帽a");
      return false;
    }
    if (formData.password.length < 4) {
      Alert.alert("Error", "La contrase帽a debe tener al menos 4 caracteres");
      return false;
    }
    return true;
  };
  /**
   * Maneja el proceso de inicio de sesi贸n
   */
  const handleLogin = (): void => {
    if (!validateForm()) {
      return;
    }
    Alert.alert(
      "Confirmaci贸n de inicio de sesi贸n",
      `驴Deseas iniciar sesi贸n como ${formData.username}?`,
      [
        {
          text: "Cancelar",
          style: "cancel",
        },
        {
          text: "Aceptar",
          onPress: authenticateUser,
        },
      ],
      { cancelable: false }
    );
  };
  /**
   * Simula el proceso de autenticaci贸n
   */
  const authenticateUser = (): void => {
    setIsLoading(true);
    // Simulamos una petici贸n al servidor (2 segundos)
    setTimeout(() => {
      setIsLoading(false);
      // Aqu铆 ir铆a la l贸gica real de autenticaci贸n
      // Por ahora, cualquier usuario/contrase帽a es v谩lido
      console.log("Usuario autenticado:", formData.username);
      // Navegamos a la pantalla principal
      navigation.replace("Home");
    }, 2000);
  };
  /**
   * Maneja la recuperaci贸n de contrase帽a
   */
  const handleForgotPassword = (): void => {
    Alert.alert(
      "Recuperar Contrase帽a",
      "Esta funcionalidad estar谩 disponible pr贸ximamente.",
      [{ text: "Entendido" }]
    );
  };
  /**
   * Maneja el registro de nuevo usuario
   */
  const handleRegister = (): void => {
    Alert.alert(
      "Registro",
      "Esta funcionalidad estar谩 disponible pr贸ximamente.",
      [{ text: "Entendido" }]
    );
  };
  return (
    <KeyboardAvoidingView
      style={styles.container}
      behavior={Platform.OS === "ios" ? "padding" : "height"}
    >
      <View style={styles.content}>
        {/* Logo de la aplicaci贸n */}
        <Image source={loginImage} style={styles.loginImage} />
        {/* T铆tulo */}
        <Text style={styles.title}>Bienvenido </Text>
        <Text style={styles.subtitle}>Iniciar Sesi贸n</Text>
        {/* Formulario */}
        <View style={styles.formContainer}>
          {/* Campo Usuario */}
          <TextInput
            style={styles.input}
            placeholder="Usuario"
            placeholderTextColor={COLORS.textSecondary}
            value={formData.username}
            onChangeText={(text) => updateFormData("username", text)}
            autoCapitalize="none"
            autoCorrect={false}
            editable={!isLoading}
          />
          {/* Campo Contrase帽a */}
          <TextInput
            style={styles.input}
            placeholder="Contrase帽a"
            placeholderTextColor={COLORS.textSecondary}
            value={formData.password}
            onChangeText={(text) => updateFormData("password", text)}
            secureTextEntry
            autoCapitalize="none"
            autoCorrect={false}
            editable={!isLoading}
          />
          {/* Bot贸n de Login */}
          <TouchableOpacity
            style={[styles.loginButton, { opacity: isLoading ? 0.6 : 1 }]}
            onPress={handleLogin}
            disabled={isLoading}
          >
            <Text style={styles.loginButtonText}>
              {isLoading ? "Iniciando sesi贸n..." : "Iniciar Sesi贸n"}
            </Text>
          </TouchableOpacity>
        </View>
        {/* Enlaces adicionales */}
        <View style={styles.linksContainer}>
          <TouchableOpacity onPress={handleForgotPassword}>
            <Text style={styles.link}>驴Olvidaste tu contrase帽a?</Text>
          </TouchableOpacity>
          <TouchableOpacity onPress={handleRegister}>
            <Text style={styles.link}></Text>
          </TouchableOpacity>
        </View>
      </View>
    </KeyboardAvoidingView>
  );
};
/**
 * Estilos del componente
 */
const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: COLORS.background,
  },
  content: {
    flex: 1,
    justifyContent: "center",
    alignItems: "center",
    paddingHorizontal: 20,
  },
  loginImage: {
    width: 120,
    height: 120,
    marginBottom: 20,
    borderRadius: 60,
  },
  title: {
    fontSize: FONT_SIZES.xxlarge,
    fontWeight: "bold",
    color: COLORS.primary,
    textAlign: "center",
    marginBottom: 8,
  },
  subtitle: {
    fontSize: FONT_SIZES.large,
    color: COLORS.textSecondary,
    textAlign: "center",
    marginBottom: 30,
  },
  formContainer: {
    width: "100%",
    maxWidth: 300,
  },
  input: {
    height: 50,
    borderColor: COLORS.textSecondary,
    borderWidth: 1,
    borderRadius: 8,
    paddingHorizontal: 15,
    marginBottom: 15,
    fontSize: FONT_SIZES.medium,
    backgroundColor: COLORS.surface,
    color: COLORS.text,
  },
  loginButton: {
    backgroundColor: COLORS.primary,
    height: 50,
    borderRadius: 8,
    justifyContent: "center",
    alignItems: "center",
    marginTop: 10,
    elevation: 2,
    shadowColor: COLORS.text,
    shadowOffset: {
      width: 0,
      height: 2,
    },
    shadowOpacity: 0.25,
    shadowRadius: 3.84,
  },
  loginButtonText: {
    color: COLORS.surface,
    fontSize: FONT_SIZES.medium,
    fontWeight: "bold",
  },
  linksContainer: {
    marginTop: 30,
    alignItems: "center",
    gap: 15,
  },
  link: {
    color: COLORS.primary,
    fontSize: FONT_SIZES.medium,
    textDecorationLine: "underline",
  },
});
export default LoginScreen;